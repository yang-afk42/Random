<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KH Explore - 除錯模式</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-5">

    <div id="debugConsole" class="bg-black text-green-400 p-4 rounded-xl text-xs font-mono mb-5 overflow-auto max-h-60 shadow-2xl border-2 border-green-600">
        > 等待資料載入...
    </div>

    <div id="dataList" class="space-y-4 pb-20"></div>

    <script>
        // 設定區
        const config = {
            csvUrl: "https://docs.google.com/spreadsheets/d/1ur6DxhLHX_hmOhBdx37eJSExtegrQ-T15uGBxzuMPKc/edit?usp=sharing"
        };

        // 關鍵字設定
        const subOptions = {
            '地點': [
                { name: '全部', key: '全部', tags: [] },
                { name: '浪漫', key: '浪漫', tags: ['夕陽', '海濱', '漁港', '夜景', '海'] },
                { name: '熱鬧', key: '熱鬧', tags: ['音演', '展覽', '音樂', '市集', '娛樂', '熱鬧'] },
                { name: '安靜', key: '安靜', tags: ['咖啡廳', '藝術', '文化', '歷史', '安靜'] },
                { name: '活潑', key: '活潑', tags: ['休閒', '運動', '露營', '公園', '活潑'] }
            ],
            '驚喜': [
                { name: '全部', key: '全部', tags: [] },
                { name: '飲', key: '飲', tags: ['飲', '茶', '咖啡', '果汁'] },
                { name: '點', key: '點', tags: ['點', '蛋糕', '麵包', '小吃', '食'] }
            ]
        };

        function log(msg) {
            const el = document.getElementById('debugConsole');
            el.innerHTML += `<div>> ${msg}</div>`;
            console.log(msg);
        }

        function fetchData() {
            // 自動修復連結
            let finalUrl = config.csvUrl;
            if (finalUrl.includes("/edit")) {
                finalUrl = finalUrl.replace(/\/edit.*$/, "/export?format=csv");
            }
            // 加上 gid=0 強制讀取第一頁 (如果有多頁的話)
            finalUrl += "&gid=0";

            log(`正在連線到: ${finalUrl}`);
            log("正在下載並解析 CSV...");

            Papa.parse(finalUrl + "&t=" + Date.now(), {
                download: true,
                header: false,
                encoding: "UTF-8",
                complete: function(results) {
                    log(`下載完成！原始資料共 ${results.data.length} 行`);
                    
                    // 印出前 3 行資料讓您檢查
                    if (results.data.length > 0) {
                        log("--- 資料預覽 (前3行) ---");
                        results.data.slice(0, 3).forEach((row, i) => {
                            log(`[第${i}行]: ${JSON.stringify(row)}`);
                        });
                        
                        // 檢查是否讀到 HTML (代表權限錯誤)
                        if (results.data[0][0] && results.data[0][0].includes("<!DOCTYPE")) {
                            log("❌ 錯誤：讀取到 HTML 代碼！請確認 Google Sheet 已開啟「知道連結的任何人都能檢視」。");
                            return;
                        }
                    } else {
                        log("❌ 錯誤：CSV 內容是空的！");
                    }

                    renderData(results.data.slice(1));
                },
                error: function(err) {
                    log(`❌ 連線失敗: ${err}`);
                }
            });
        }

        function renderData(rows) {
            const list = document.getElementById('dataList');
            let count = 0;

            rows.forEach(cols => {
                // 簡單寬鬆模式：只要有字就顯示出來
                if (!cols[0]) return; 

                const item = {
                    district: cols[0],
                    name: cols[1],
                    category: cols[2],
                    type: cols[3],
                    brand: cols[4],
                    detail: cols[5]
                };

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow border border-slate-200";
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${item.name || '無名稱'}</h3>
                    <p class="text-sm text-gray-600">
                        區域: ${item.district} | 
                        出遊: <span class="text-blue-600 font-bold">${item.category || '-'}</span> | 
                        驚喜: <span class="text-pink-600 font-bold">${item.type || '-'}</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        原始資料: ${JSON.stringify(cols)}
                    </p>
                `;
                list.appendChild(card);
                count++;
            });

            if (count === 0) {
                log("⚠️ 資料解析後沒有產生任何卡片，可能是欄位內容都是空的？");
            } else {
                log(`✅ 成功渲染 ${count} 張卡片`);
            }
        }

        window.onload = fetchData;
    </script>
</body>
</html>
